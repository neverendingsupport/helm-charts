---
# Source: nes-node-web/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: nes-node-web
  # namespace
spec:
  selector:
    app: nes-node-web
    
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
---
# Source: nes-node-web/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nes-node-web
  namespace:
spec:
  progressDeadlineSeconds: 600
  replicas: 2
  strategy:
    rollingUpdate:
      maxSurge: 50%
      maxUnavailable: 1
  selector:
    matchLabels:
      app: nes-node-web
      release: deployed
  template:
    metadata:
      labels:
        app: nes-node-web
        release: deployed
    spec:
      containers:
        - name: nes-node-web
          image: ":1.2.3"
          imagePullPolicy: Always  
          resources:
            limits:
              memory: 350Mi
              cpu: 110m
            requests:
              memory: 300Mi
              cpu: 100m
          livenessProbe:
            httpGet:
              path: /
              port: 3000
              scheme: HTTP
            failureThreshold: 10
            initialDelaySeconds: 7 
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 1
          readinessProbe:
            httpGet:
              path: /
              port: 3000
              scheme: HTTP
            failureThreshold: 10
            initialDelaySeconds: 7 
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 1
          ports:
            - containerPort: 3000
              name: http
          env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name 

      volumes:
---
# Source: nes-node-web/templates/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nes-node-web
  # namespace
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    cert-manager.io/cluster-issuer: letsencrypt-prod
    forecastle.stakater.com/expose: "true"
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    alb.ingress.kubernetes.io/ip-address-type: dualstack
spec:
  # ingressClassName: nginx
  tls:
  - secretName: nes-node-web-tls
    hosts:  
      - "."
  rules:
  - host: "."
    http:
      paths:
      - path: /(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: nes-node-web
            port: 
              number: 3000
---
# Source: nes-node-web/templates/secrets.yaml
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name:  "aws-secretsmanager"
spec:
  provider:
    aws:
      region: us-west-2
      service: SecretsManager
